PROJECT_NAME="likewise-open"
MODULES="core compiler autotools moonunit pkg-config likewise dceidl fortune"
LW_ALL_BUNDLED="krb5 cyrus-sasl openldap libiconv \
                sqlite libuuid openssl curl libxml2"
SUBDIRS="$LW_ALL_BUNDLED \
         lwbase lwmsg lwreg pstore lwadvapi netlogon \
         lwio libschannel dcerpc lwdns centutils lwsm eventlog lsass \
         srvsvc lwnetapi lwtools domainjoin config package"


defaults()
{
    MK_PREFIX="/opt/likewise"
    MK_SYSCONFDIR="/etc/likewise"
    MK_LOCALSTATEDIR="/var"
    MK_DATADIR="/opt/likewise/share"
    MK_DOCDIR="/usr/share/doc/likewise"
    MK_MANDIR="/usr/share/man"
}

option()
{
    case "${MK_HOST_OS}" in
        linux)
            default_bundled="libuuid krb5 cyrus-sasl openldap sqlite openssl curl"
            ;;
        *)
            default_bundled="libiconv libuuid krb5 cyrus-sasl openldap sqlite openssl curl libxml2"
            ;;
    esac

    mk_option \
        OPTION=lw-bundled-libs \
        PARAM='...' \
        VAR=_LW_BUNDLED \
        DEFAULT="$default_bundled" \
        HELP="Use bundled libraries"

    unset LW_BUNDLED
    
    for i in ${_LW_BUNDLED}
    do
        case "$i" in
            +*)
                [ -z "$LW_BUNDLED" ] && LW_BUNDLED="$default_bundled"
                LW_BUNDLED="${LW_BUNDLED:+$LW_BUNDLED }${i#+}"
                ;;
            -*)
                [ -z "$LW_BUNDLED" ] && LW_BUNDLED="$default_bundled"
                lw_filter_bundled "${i#-}"
                ;;
            *)
                LW_BUNDLED="${LW_BUNDLED:+$LW_BUNDLED }${i}"
                ;;
        esac
    done
}

configure()
{
    mk_export LW_VERSION="6.1.0"
    mk_export LW_BUNDLED
    
    mk_msg "configuring Likewise Open $LW_VERSION"
    mk_msg "using bundled libraries: $LW_BUNDLED"

    for comp in ${LW_ALL_BUNDLED}
    do
        lw_use_bundled "$comp" || mk_skip_subdir "$comp"
    done
}

make()
{
    bundled_targets=""

    for comp in ${LW_ALL_BUNDLED}
    do
        lw_use_bundled "$comp" && bundled_targets="$bundled_targets @$comp"
    done
            
    mk_target \
        TARGET="@bundled" \
        DEPS="$bundled_targets @lwreg/libedit @dcerpc/flex-2.5.4"

    mk_add_phony_target "$result"
}

lw_use_bundled()
{
    for _dep in ${LW_BUNDLED}
    do
        [ "$_dep" = "$1" ] && return 0
    done

    return 1
}